<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dubuque Farmers Market - Interactive Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root {
            /* Market Brand Colors */
            --market-green: #2D5A27;
            --market-green-light: #4A7C43;
            --market-gold: #D4A84B;
            --market-cream: #F5F2E8;
            --market-brown: #5D4E37;
            
            /* Functional Colors */
            --parking-color: #E8B930;
            --restroom-color: #C75B39;
            --seating-color: #8B4A6B;
            --info-color: #3D7EAA;
            --token-color: #D4A84B;
            
            /* Vendor Type Colors */
            --grower-color: #2D8B4E;
            --prepared-food-color: #C76832;
            --artisan-color: #5B6AAF;
            
            /* UI Colors */
            --marker-border: rgba(255, 255, 255, 0.9);
            --popup-border: #E5E5E0;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-medium: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Outfit', sans-serif; background: var(--market-cream); }
        
        /* ========== HEADER ========== */
        header {
            background: linear-gradient(135deg, var(--market-green) 0%, var(--market-green-light) 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            box-shadow: var(--shadow-medium);
            position: relative;
            z-index: 1001;
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-brand .logo {
            width: 44px;
            height: 44px;
            background: var(--market-gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        .header-brand h1 {
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }
        .header-brand .subtitle {
            font-size: 0.75rem;
            opacity: 0.85;
            font-weight: 400;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
        }
        
        .filter-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-btn:hover { 
            background: rgba(255,255,255,0.25); 
            transform: translateY(-1px);
        }
        .filter-btn.active { 
            background: white; 
            color: var(--market-green);
            border-color: white;
        }
        .filter-btn i { font-size: 0.9em; }
        
        .search-container {
            position: relative;
            margin-left: auto;
        }
        .search-container input {
            padding: 10px 16px 10px 40px;
            border: none;
            border-radius: 25px;
            font-family: inherit;
            font-size: 0.9rem;
            width: 220px;
            background: rgba(255,255,255,0.95);
            box-shadow: var(--shadow-soft);
        }
        .search-container input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.4);
        }
        .search-container i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--market-green);
            opacity: 0.6;
        }
        
        .status-badge {
            background: rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-badge .dot {
            width: 8px;
            height: 8px;
            background: #7FD47F;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ========== MAP CONTAINER ========== */
        #map-container {
            position: fixed;
            top: 80px;
            bottom: 0;
            left: 0;
            right: 0;
        }
        #map {
            height: 100%;
            width: 100%;
            background: #E8E4D8;
        }
        
        /* ========== MAP CONTROLS ========== */
        .map-control-btn {
            position: absolute;
            z-index: 1000;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: white;
            border: none;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .map-control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
        }
        .map-control-btn i { font-size: 20px; color: var(--market-green); }
        
        #locate-btn { bottom: 100px; right: 16px; }
        #zoom-fit-btn { bottom: 160px; right: 16px; }
        
        .map-control-btn.locating i {
            animation: spin 1s linear infinite;
            color: var(--info-color);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* ========== LEGEND ========== */
        .map-legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            z-index: 1000;
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: var(--shadow-medium);
            font-size: 0.8rem;
        }
        .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--market-brown);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .legend-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        /* ========== MARKER STYLES ========== */
        .vendor-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid var(--marker-border);
            box-shadow: var(--shadow-medium);
            transition: all 0.2s ease;
        }
        .vendor-marker:hover { transform: scale(1.1); }
        .vendor-marker i { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .multi-stall-marker {
            border-radius: 20px;
            border: 3px solid var(--marker-border);
            box-shadow: var(--shadow-medium);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .multi-stall-marker i { color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3); }
        
        .poi-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid var(--marker-border);
            box-shadow: var(--shadow-soft);
        }
        .poi-marker i { color: white; }
        
        .dimmed { opacity: 0.35; }
        
        .user-location {
            width: 18px;
            height: 18px;
            background: #4285F4;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(66, 133, 244, 0.6);
        }
        
        /* ========== POPUPS ========== */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: var(--shadow-medium);
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content { margin: 0; width: auto !important; }
        .leaflet-popup-tip { background: white; }
        
        .popup-card { min-width: 280px; max-width: 320px; }
        .popup-header {
            padding: 14px 16px 12px;
            border-bottom: 1px solid var(--popup-border);
        }
        .popup-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--market-brown);
            margin-bottom: 6px;
        }
        .popup-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
        }
        .popup-stalls {
            font-size: 0.85rem;
            color: #666;
            margin-top: 6px;
        }
        .popup-body { padding: 12px 16px; }
        .popup-description {
            font-size: 0.9rem;
            color: #444;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .popup-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .popup-tag {
            background: var(--market-cream);
            color: var(--market-brown);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
        }
        .popup-footer {
            padding: 10px 16px 14px;
            border-top: 1px solid var(--popup-border);
            display: flex;
            gap: 8px;
        }
        .popup-btn {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .popup-btn-primary {
            background: var(--market-green);
            color: white;
        }
        .popup-btn-primary:hover { background: var(--market-green-light); }
        .popup-btn-secondary {
            background: var(--market-cream);
            color: var(--market-brown);
        }
        .popup-btn-secondary:hover { background: #EBE7DB; }
        
        /* Area polygons */
        .area-parking { fill-opacity: 0.2; stroke-width: 2; }
        .area-seating { fill-opacity: 0.25; stroke-width: 2; }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            header { padding: 12px 16px; }
            .header-brand h1 { font-size: 1rem; }
            .filter-btn { padding: 8px 12px; font-size: 0.8rem; }
            .search-container input { width: 160px; }
            .map-legend { display: none; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-brand">
            <div class="logo">ðŸ¥•</div>
            <div>
                <h1>Dubuque Farmers Market</h1>
                <div class="subtitle">Upper Main District â€¢ Saturdays 7amâ€“12pm</div>
            </div>
        </div>
        
        <div class="header-controls">
            <button class="filter-btn" onclick="loadMockData()" id="load-btn">
                <i class="fa-solid fa-map"></i> Load Map
            </button>
            <button class="filter-btn" onclick="filterByType('Grower/Producer/Processor')">
                <i class="fa-solid fa-leaf"></i> Farm Fresh
            </button>
            <button class="filter-btn" onclick="filterByType('On-site Prepared Food Vendor')">
                <i class="fa-solid fa-utensils"></i> Ready to Eat
            </button>
            <button class="filter-btn" onclick="filterByKeyword('coffee')">
                <i class="fa-solid fa-mug-hot"></i> Coffee
            </button>
            <button class="filter-btn" onclick="clearFilters()">
                <i class="fa-solid fa-rotate-left"></i> Clear
            </button>
            
            <div class="search-container">
                <i class="fa-solid fa-search"></i>
                <input type="text" id="search-input" placeholder="Search vendors..." oninput="handleSearch(this.value)">
            </div>
            
            <div class="status-badge">
                <span class="dot"></span>
                <span id="status-text">Ready</span>
            </div>
        </div>
    </header>
    
    <div id="map-container">
        <div id="map"></div>
        
        <button id="zoom-fit-btn" class="map-control-btn" title="Return to market view" onclick="fitAllMarkers()">
            <i class="fa-solid fa-house"></i>
        </button>
        <button id="locate-btn" class="map-control-btn" title="Find my location">
            <i class="fa-solid fa-location-crosshairs"></i>
        </button>
        
        <div class="map-legend">
            <div class="legend-title">Vendor Types</div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--grower-color);"></div>
                <span>Farm Fresh / Producer</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--prepared-food-color);"></div>
                <span>Ready to Eat</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--artisan-color);"></div>
                <span>Artisan / Crafter</span>
            </div>
            <div style="margin-top: 10px;" class="legend-title">Amenities</div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--parking-color);"></div>
                <span>Public Parking</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--restroom-color);"></div>
                <span>Restrooms</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: var(--info-color);"></div>
                <span>Information</span>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // REAL STALL DATA - From Dubuque Farmers Market GeoJSON
        // Market spans Iowa Street in the Upper Main District
        // Blocks: A (south), B, C, D, G, H, J, K, L (various areas)
        // ============================================================
        
        const MOCK_STALL_LAYOUTS = [
            // Block A - Southern section (A1-A22)
            { title: "A1", geoJsonFeature: '{"type":"Feature","properties":{"title":"A1"},"geometry":{"type":"Point","coordinates":[-90.66705665947119,42.50288881769179]}}' },
            { title: "A3", geoJsonFeature: '{"type":"Feature","properties":{"title":"A3"},"geometry":{"type":"Point","coordinates":[-90.66712510378238,42.5030004723114]}}' },
            { title: "A4", geoJsonFeature: '{"type":"Feature","properties":{"title":"A4"},"geometry":{"type":"Point","coordinates":[-90.66716304600405,42.50306035327537]}}' },
            { title: "A5", geoJsonFeature: '{"type":"Feature","properties":{"title":"A5"},"geometry":{"type":"Point","coordinates":[-90.66719191153116,42.50311560056699]}}' },
            { title: "A6", geoJsonFeature: '{"type":"Feature","properties":{"title":"A6"},"geometry":{"type":"Point","coordinates":[-90.66721985562177,42.50316592740278]}}' },
            { title: "A7", geoJsonFeature: '{"type":"Feature","properties":{"title":"A7"},"geometry":{"type":"Point","coordinates":[-90.66725381869665,42.50323122551035]}}' },
            { title: "A8", geoJsonFeature: '{"type":"Feature","properties":{"title":"A8"},"geometry":{"type":"Point","coordinates":[-90.66728559647514,42.5032953256069]}}' },
            { title: "A9", geoJsonFeature: '{"type":"Feature","properties":{"title":"A9"},"geometry":{"type":"Point","coordinates":[-90.66732083101151,42.50336652400467]}}' },
            { title: "A10", geoJsonFeature: '{"type":"Feature","properties":{"title":"A10"},"geometry":{"type":"Point","coordinates":[-90.66735307077465,42.50343233301088]}}' },
            { title: "A11", geoJsonFeature: '{"type":"Feature","properties":{"title":"A11"},"geometry":{"type":"Point","coordinates":[-90.66738266246458,42.50349916700823]}}' },
            { title: "A12", geoJsonFeature: '{"type":"Feature","properties":{"title":"A12"},"geometry":{"type":"Point","coordinates":[-90.66697442504707,42.50292448401543]}}' },
            { title: "A13", geoJsonFeature: '{"type":"Feature","properties":{"title":"A13"},"geometry":{"type":"Point","coordinates":[-90.66705460027254,42.50308437507127]}}' },
            { title: "A14", geoJsonFeature: '{"type":"Feature","properties":{"title":"A14"},"geometry":{"type":"Point","coordinates":[-90.66708474840956,42.50313404208068]}}' },
            { title: "A15", geoJsonFeature: '{"type":"Feature","properties":{"title":"A15"},"geometry":{"type":"Point","coordinates":[-90.66710409220796,42.50317608421996]}}' },
            { title: "A16", geoJsonFeature: '{"type":"Feature","properties":{"title":"A16"},"geometry":{"type":"Point","coordinates":[-90.66712670798532,42.50322185425855]}}' },
            { title: "A17", geoJsonFeature: '{"type":"Feature","properties":{"title":"A17"},"geometry":{"type":"Point","coordinates":[-90.6671512673735,42.50328837233806]}}' },
            { title: "A18", geoJsonFeature: '{"type":"Feature","properties":{"title":"A18"},"geometry":{"type":"Point","coordinates":[-90.66719156065443,42.50334164257448]}}' },
            { title: "A19", geoJsonFeature: '{"type":"Feature","properties":{"title":"A19"},"geometry":{"type":"Point","coordinates":[-90.66721889980877,42.50339079416094]}}' },
            { title: "A20", geoJsonFeature: '{"type":"Feature","properties":{"title":"A20"},"geometry":{"type":"Point","coordinates":[-90.66724256295633,42.50343562226184]}}' },
            { title: "A21", geoJsonFeature: '{"type":"Feature","properties":{"title":"A21"},"geometry":{"type":"Point","coordinates":[-90.66727339798435,42.5034911135565]}}' },
            { title: "A22", geoJsonFeature: '{"type":"Feature","properties":{"title":"A22"},"geometry":{"type":"Point","coordinates":[-90.66731393682237,42.50354928872903]}}' },
            
            // Block B - Middle-south section (B2-B22)
            { title: "B2", geoJsonFeature: '{"type":"Feature","properties":{"title":"B2"},"geometry":{"type":"Point","coordinates":[-90.6675367061987,42.50375233896381]}}' },
            { title: "B3", geoJsonFeature: '{"type":"Feature","properties":{"title":"B3"},"geometry":{"type":"Point","coordinates":[-90.66755791715761,42.50380086781333]}}' },
            { title: "B4", geoJsonFeature: '{"type":"Feature","properties":{"title":"B4"},"geometry":{"type":"Point","coordinates":[-90.66758879690798,42.50385222111934]}}' },
            { title: "B5", geoJsonFeature: '{"type":"Feature","properties":{"title":"B5"},"geometry":{"type":"Point","coordinates":[-90.66761237226906,42.50390745210163]}}' },
            { title: "B6", geoJsonFeature: '{"type":"Feature","properties":{"title":"B6"},"geometry":{"type":"Point","coordinates":[-90.66764686371874,42.50396329005688]}}' },
            { title: "B7", geoJsonFeature: '{"type":"Feature","properties":{"title":"B7"},"geometry":{"type":"Point","coordinates":[-90.66767250409838,42.50401902914289]}}' },
            { title: "B8", geoJsonFeature: '{"type":"Feature","properties":{"title":"B8"},"geometry":{"type":"Point","coordinates":[-90.66770751962105,42.50408330732886]}}' },
            { title: "B9", geoJsonFeature: '{"type":"Feature","properties":{"title":"B9"},"geometry":{"type":"Point","coordinates":[-90.6677405993191,42.50413352961261]}}' },
            { title: "B10", geoJsonFeature: '{"type":"Feature","properties":{"title":"B10"},"geometry":{"type":"Point","coordinates":[-90.6677706480619,42.50419382446457]}}' },
            { title: "B11", geoJsonFeature: '{"type":"Feature","properties":{"title":"B11"},"geometry":{"type":"Point","coordinates":[-90.66781220904359,42.50425917138577]}}' },
            { title: "B12", geoJsonFeature: '{"type":"Feature","properties":{"title":"B12"},"geometry":{"type":"Point","coordinates":[-90.66739817228763,42.50370734310031]}}' },
            { title: "B13", geoJsonFeature: '{"type":"Feature","properties":{"title":"B13"},"geometry":{"type":"Point","coordinates":[-90.6674295049451,42.50378071094573]}}' },
            { title: "B14", geoJsonFeature: '{"type":"Feature","properties":{"title":"B14"},"geometry":{"type":"Point","coordinates":[-90.66746918611781,42.50384251799378]}}' },
            { title: "B15", geoJsonFeature: '{"type":"Feature","properties":{"title":"B15"},"geometry":{"type":"Point","coordinates":[-90.66749926717792,42.50390213646376]}}' },
            { title: "B16", geoJsonFeature: '{"type":"Feature","properties":{"title":"B16"},"geometry":{"type":"Point","coordinates":[-90.66753061802771,42.50395535742168]}}' },
            { title: "B17", geoJsonFeature: '{"type":"Feature","properties":{"title":"B17"},"geometry":{"type":"Point","coordinates":[-90.66756288054864,42.50401424789655]}}' },
            { title: "B18", geoJsonFeature: '{"type":"Feature","properties":{"title":"B18"},"geometry":{"type":"Point","coordinates":[-90.6675914387336,42.50407092825023]}}' },
            { title: "B19", geoJsonFeature: '{"type":"Feature","properties":{"title":"B19"},"geometry":{"type":"Point","coordinates":[-90.66762482098022,42.50412738752548]}}' },
            { title: "B20", geoJsonFeature: '{"type":"Feature","properties":{"title":"B20"},"geometry":{"type":"Point","coordinates":[-90.66765967445447,42.50418691589091]}}' },
            { title: "B21", geoJsonFeature: '{"type":"Feature","properties":{"title":"B21"},"geometry":{"type":"Point","coordinates":[-90.66768726853577,42.50424568173472]}}' },
            
            // Block C (C1-C2)
            { title: "C1", geoJsonFeature: '{"type":"Feature","properties":{"title":"C1"},"geometry":{"type":"Point","coordinates":[-90.66798769334905,42.50434201564535]}}' },
            { title: "C2", geoJsonFeature: '{"type":"Feature","properties":{"title":"C2"},"geometry":{"type":"Point","coordinates":[-90.6681183465567,42.50431012217301]}}' },
            
            // Block D - East side (D1-D23)
            { title: "D1", geoJsonFeature: '{"type":"Feature","properties":{"title":"D1"},"geometry":{"type":"Point","coordinates":[-90.66794958159201,42.50453379579217]}}' },
            { title: "D2", geoJsonFeature: '{"type":"Feature","properties":{"title":"D2"},"geometry":{"type":"Point","coordinates":[-90.66798547988041,42.50459704730823]}}' },
            { title: "D3", geoJsonFeature: '{"type":"Feature","properties":{"title":"D3"},"geometry":{"type":"Point","coordinates":[-90.66802108991388,42.50464921010212]}}' },
            { title: "D4", geoJsonFeature: '{"type":"Feature","properties":{"title":"D4"},"geometry":{"type":"Point","coordinates":[-90.66805685660393,42.50470323961218]}}' },
            { title: "D5", geoJsonFeature: '{"type":"Feature","properties":{"title":"D5"},"geometry":{"type":"Point","coordinates":[-90.66809086469391,42.50476168701738]}}' },
            { title: "D6", geoJsonFeature: '{"type":"Feature","properties":{"title":"D6"},"geometry":{"type":"Point","coordinates":[-90.66812485785857,42.50483020942525]}}' },
            { title: "D7", geoJsonFeature: '{"type":"Feature","properties":{"title":"D7"},"geometry":{"type":"Point","coordinates":[-90.66816230951441,42.50489818508811]}}' },
            { title: "D8", geoJsonFeature: '{"type":"Feature","properties":{"title":"D8"},"geometry":{"type":"Point","coordinates":[-90.6681981391406,42.50495989738871]}}' },
            { title: "D9", geoJsonFeature: '{"type":"Feature","properties":{"title":"D9"},"geometry":{"type":"Point","coordinates":[-90.66823765534738,42.50503244433477]}}' },
            { title: "D10", geoJsonFeature: '{"type":"Feature","properties":{"title":"D10"},"geometry":{"type":"Point","coordinates":[-90.66827900847099,42.50510633945065]}}' },
            { title: "D11", geoJsonFeature: '{"type":"Feature","properties":{"title":"D11"},"geometry":{"type":"Point","coordinates":[-90.66830851547313,42.505165535643]}}' },
            { title: "D13", geoJsonFeature: '{"type":"Feature","properties":{"title":"D13"},"geometry":{"type":"Point","coordinates":[-90.66789467633757,42.50461060351194]}}' },
            { title: "D14", geoJsonFeature: '{"type":"Feature","properties":{"title":"D14"},"geometry":{"type":"Point","coordinates":[-90.66792734584268,42.50467028380624]}}' },
            { title: "D15", geoJsonFeature: '{"type":"Feature","properties":{"title":"D15"},"geometry":{"type":"Point","coordinates":[-90.66795622806715,42.50472852964036]}}' },
            { title: "D16", geoJsonFeature: '{"type":"Feature","properties":{"title":"D16"},"geometry":{"type":"Point","coordinates":[-90.66799570012348,42.50479222485867]}}' },
            { title: "D17", geoJsonFeature: '{"type":"Feature","properties":{"title":"D17"},"geometry":{"type":"Point","coordinates":[-90.66802302774127,42.50484730242502]}}' },
            { title: "D18", geoJsonFeature: '{"type":"Feature","properties":{"title":"D18"},"geometry":{"type":"Point","coordinates":[-90.66806165648785,42.50491632106042]}}' },
            { title: "D19", geoJsonFeature: '{"type":"Feature","properties":{"title":"D19"},"geometry":{"type":"Point","coordinates":[-90.668100653483,42.50499168765101]}}' },
            { title: "D20", geoJsonFeature: '{"type":"Feature","properties":{"title":"D20"},"geometry":{"type":"Point","coordinates":[-90.66813442475065,42.50506631053668]}}' },
            { title: "D21", geoJsonFeature: '{"type":"Feature","properties":{"title":"D21"},"geometry":{"type":"Point","coordinates":[-90.6681607017292,42.50514007292306]}}' },
            { title: "D22", geoJsonFeature: '{"type":"Feature","properties":{"title":"D22"},"geometry":{"type":"Point","coordinates":[-90.6681945280406,42.50519389806157]}}' },
            { title: "D23", geoJsonFeature: '{"type":"Feature","properties":{"title":"D23"},"geometry":{"type":"Point","coordinates":[-90.66826699837794,42.50529202872439]}}' },
            
            // Block G - Center (G1-G18)
            { title: "G1", geoJsonFeature: '{"type":"Feature","properties":{"title":"G1"},"geometry":{"type":"Point","coordinates":[-90.667677039934,42.5044370370483]}}' },
            { title: "G2", geoJsonFeature: '{"type":"Feature","properties":{"title":"G2"},"geometry":{"type":"Point","coordinates":[-90.66761552054714,42.50445611894784]}}' },
            { title: "G3", geoJsonFeature: '{"type":"Feature","properties":{"title":"G3"},"geometry":{"type":"Point","coordinates":[-90.66755461400811,42.50447392394741]}}' },
            { title: "G4", geoJsonFeature: '{"type":"Feature","properties":{"title":"G4"},"geometry":{"type":"Point","coordinates":[-90.66748639788439,42.50449098481444]}}' },
            { title: "G5", geoJsonFeature: '{"type":"Feature","properties":{"title":"G5"},"geometry":{"type":"Point","coordinates":[-90.66739913881108,42.50452049259945]}}' },
            { title: "G6", geoJsonFeature: '{"type":"Feature","properties":{"title":"G6"},"geometry":{"type":"Point","coordinates":[-90.66726776955187,42.5045606570496]}}' },
            { title: "G7", geoJsonFeature: '{"type":"Feature","properties":{"title":"G7"},"geometry":{"type":"Point","coordinates":[-90.66716741184949,42.50458806599863]}}' },
            { title: "G8", geoJsonFeature: '{"type":"Feature","properties":{"title":"G8"},"geometry":{"type":"Point","coordinates":[-90.66708221456506,42.50461375556765]}}' },
            { title: "G9", geoJsonFeature: '{"type":"Feature","properties":{"title":"G9"},"geometry":{"type":"Point","coordinates":[-90.66700393362504,42.5046372012868]}}' },
            { title: "G10", geoJsonFeature: '{"type":"Feature","properties":{"title":"G10"},"geometry":{"type":"Point","coordinates":[-90.66772585869536,42.5045075744363]}}' },
            { title: "G11", geoJsonFeature: '{"type":"Feature","properties":{"title":"G11"},"geometry":{"type":"Point","coordinates":[-90.66766548190276,42.50452653862856]}}' },
            { title: "G12", geoJsonFeature: '{"type":"Feature","properties":{"title":"G12"},"geometry":{"type":"Point","coordinates":[-90.66758599202356,42.50455105040253]}}' },
            { title: "G13", geoJsonFeature: '{"type":"Feature","properties":{"title":"G13"},"geometry":{"type":"Point","coordinates":[-90.66750605331742,42.50457174339366]}}' },
            { title: "G14", geoJsonFeature: '{"type":"Feature","properties":{"title":"G14"},"geometry":{"type":"Point","coordinates":[-90.66742288858639,42.50459699110312]}}' },
            { title: "G15", geoJsonFeature: '{"type":"Feature","properties":{"title":"G15"},"geometry":{"type":"Point","coordinates":[-90.66729814776193,42.50463699594975]}}' },
            { title: "G16", geoJsonFeature: '{"type":"Feature","properties":{"title":"G16"},"geometry":{"type":"Point","coordinates":[-90.6672074570144,42.50465942758358]}}' },
            { title: "G17", geoJsonFeature: '{"type":"Feature","properties":{"title":"G17"},"geometry":{"type":"Point","coordinates":[-90.66712075875225,42.50468364826079]}}' },
            { title: "G18", geoJsonFeature: '{"type":"Feature","properties":{"title":"G18"},"geometry":{"type":"Point","coordinates":[-90.6670448707613,42.50470441092738]}}' },
            
            // Block H - Food court area (H1-H13)
            { title: "H1", geoJsonFeature: '{"type":"Feature","properties":{"title":"H1"},"geometry":{"type":"Point","coordinates":[-90.66731275492211,42.50474272740103]}}' },
            { title: "H2", geoJsonFeature: '{"type":"Feature","properties":{"title":"H2"},"geometry":{"type":"Point","coordinates":[-90.66724298374609,42.50475996650351]}}' },
            { title: "H3", geoJsonFeature: '{"type":"Feature","properties":{"title":"H3"},"geometry":{"type":"Point","coordinates":[-90.6671827072875,42.50477808736805]}}' },
            { title: "H4", geoJsonFeature: '{"type":"Feature","properties":{"title":"H4"},"geometry":{"type":"Point","coordinates":[-90.667124204789,42.50479130032567]}}' },
            { title: "H5", geoJsonFeature: '{"type":"Feature","properties":{"title":"H5"},"geometry":{"type":"Point","coordinates":[-90.66712203825846,42.50485061858101]}}' },
            { title: "H6", geoJsonFeature: '{"type":"Feature","properties":{"title":"H6"},"geometry":{"type":"Point","coordinates":[-90.66715867545783,42.50490248682734]}}' },
            { title: "H8", geoJsonFeature: '{"type":"Feature","properties":{"title":"H8"},"geometry":{"type":"Point","coordinates":[-90.66719116632214,42.50494986603375]}}' },
            { title: "H9", geoJsonFeature: '{"type":"Feature","properties":{"title":"H9"},"geometry":{"type":"Point","coordinates":[-90.66721447371198,42.50499690690271]}}' },
            { title: "H10", geoJsonFeature: '{"type":"Feature","properties":{"title":"H10"},"geometry":{"type":"Point","coordinates":[-90.6672509794789,42.5050506927416]}}' },
            { title: "H11", geoJsonFeature: '{"type":"Feature","properties":{"title":"H11"},"geometry":{"type":"Point","coordinates":[-90.667312830993,42.50503450221655]}}' },
            { title: "H12", geoJsonFeature: '{"type":"Feature","properties":{"title":"H12"},"geometry":{"type":"Point","coordinates":[-90.66737124704818,42.5050140125968]}}' },
            { title: "H13", geoJsonFeature: '{"type":"Feature","properties":{"title":"H13"},"geometry":{"type":"Point","coordinates":[-90.66743335410695,42.50499876667421]}}' },
            
            // Block J - North section (J1-J20)
            { title: "J1", geoJsonFeature: '{"type":"Feature","properties":{"title":"J1"},"geometry":{"type":"Point","coordinates":[-90.66811790621556,42.50524157367239]}}' },
            { title: "J2", geoJsonFeature: '{"type":"Feature","properties":{"title":"J2"},"geometry":{"type":"Point","coordinates":[-90.66804722790299,42.50526190896181]}}' },
            { title: "J3", geoJsonFeature: '{"type":"Feature","properties":{"title":"J3"},"geometry":{"type":"Point","coordinates":[-90.66797809754387,42.50528318623664]}}' },
            { title: "J4", geoJsonFeature: '{"type":"Feature","properties":{"title":"J4"},"geometry":{"type":"Point","coordinates":[-90.66789945878907,42.50530511430289]}}' },
            { title: "J5", geoJsonFeature: '{"type":"Feature","properties":{"title":"J5"},"geometry":{"type":"Point","coordinates":[-90.66781898990689,42.50532988402282]}}' },
            { title: "J6", geoJsonFeature: '{"type":"Feature","properties":{"title":"J6"},"geometry":{"type":"Point","coordinates":[-90.66773606298634,42.50534849168738]}}' },
            { title: "J7", geoJsonFeature: '{"type":"Feature","properties":{"title":"J7"},"geometry":{"type":"Point","coordinates":[-90.66765436982816,42.50538022326578]}}' },
            { title: "J8", geoJsonFeature: '{"type":"Feature","properties":{"title":"J8"},"geometry":{"type":"Point","coordinates":[-90.66758373868622,42.50539891276733]}}' },
            { title: "J9", geoJsonFeature: '{"type":"Feature","properties":{"title":"J9"},"geometry":{"type":"Point","coordinates":[-90.66751567756693,42.50542058086205]}}' },
            { title: "J10", geoJsonFeature: '{"type":"Feature","properties":{"title":"J10"},"geometry":{"type":"Point","coordinates":[-90.66743132127603,42.50544210174986]}}' },
            { title: "J11", geoJsonFeature: '{"type":"Feature","properties":{"title":"J11"},"geometry":{"type":"Point","coordinates":[-90.66817256817802,42.50532706733545]}}' },
            { title: "J12", geoJsonFeature: '{"type":"Feature","properties":{"title":"J12"},"geometry":{"type":"Point","coordinates":[-90.66809434878068,42.50534829649586]}}' },
            { title: "J13", geoJsonFeature: '{"type":"Feature","properties":{"title":"J13"},"geometry":{"type":"Point","coordinates":[-90.66802002046275,42.50537151076954]}}' },
            { title: "J14", geoJsonFeature: '{"type":"Feature","properties":{"title":"J14"},"geometry":{"type":"Point","coordinates":[-90.66795711889247,42.50538898403149]}}' },
            { title: "J15", geoJsonFeature: '{"type":"Feature","properties":{"title":"J15"},"geometry":{"type":"Point","coordinates":[-90.66787423118676,42.50540848863596]}}' },
            { title: "J16", geoJsonFeature: '{"type":"Feature","properties":{"title":"J16"},"geometry":{"type":"Point","coordinates":[-90.66780385141534,42.50543097736743]}}' },
            { title: "J17", geoJsonFeature: '{"type":"Feature","properties":{"title":"J17"},"geometry":{"type":"Point","coordinates":[-90.66772763703364,42.50546066417077]}}' },
            { title: "J18", geoJsonFeature: '{"type":"Feature","properties":{"title":"J18"},"geometry":{"type":"Point","coordinates":[-90.6676387007715,42.50547844204462]}}' },
            { title: "J19", geoJsonFeature: '{"type":"Feature","properties":{"title":"J19"},"geometry":{"type":"Point","coordinates":[-90.6675589575828,42.50549911219981]}}' },
            { title: "J20", geoJsonFeature: '{"type":"Feature","properties":{"title":"J20"},"geometry":{"type":"Point","coordinates":[-90.66747930781358,42.50552278422755]}}' },
            
            // Block K - West side (K1-K10)
            { title: "K1", geoJsonFeature: '{"type":"Feature","properties":{"title":"K1"},"geometry":{"type":"Point","coordinates":[-90.6674852866057,42.50355099068591]}}' },
            { title: "K2", geoJsonFeature: '{"type":"Feature","properties":{"title":"K2"},"geometry":{"type":"Point","coordinates":[-90.66757644630707,42.5035261298726]}}' },
            { title: "K3", geoJsonFeature: '{"type":"Feature","properties":{"title":"K3"},"geometry":{"type":"Point","coordinates":[-90.66765386167783,42.50350449393036]}}' },
            { title: "K4", geoJsonFeature: '{"type":"Feature","properties":{"title":"K4"},"geometry":{"type":"Point","coordinates":[-90.66773121366259,42.50348334535732]}}' },
            { title: "K5", geoJsonFeature: '{"type":"Feature","properties":{"title":"K5"},"geometry":{"type":"Point","coordinates":[-90.66781300674833,42.50345972027561]}}' },
            { title: "K6", geoJsonFeature: '{"type":"Feature","properties":{"title":"K6"},"geometry":{"type":"Point","coordinates":[-90.66752546555989,42.50362394530556]}}' },
            { title: "K7", geoJsonFeature: '{"type":"Feature","properties":{"title":"K7"},"geometry":{"type":"Point","coordinates":[-90.66760809302495,42.50360220914801]}}' },
            { title: "K8", geoJsonFeature: '{"type":"Feature","properties":{"title":"K8"},"geometry":{"type":"Point","coordinates":[-90.66768129024142,42.50357783573558]}}' },
            { title: "K9", geoJsonFeature: '{"type":"Feature","properties":{"title":"K9"},"geometry":{"type":"Point","coordinates":[-90.66776561355529,42.50355593967722]}}' },
            { title: "K10", geoJsonFeature: '{"type":"Feature","properties":{"title":"K10"},"geometry":{"type":"Point","coordinates":[-90.66784574635032,42.50353136469177]}}' },
            
            // Block L - Corner (L1-L8)
            { title: "L1", geoJsonFeature: '{"type":"Feature","properties":{"title":"L1"},"geometry":{"type":"Point","coordinates":[-90.6672535586953,42.50361724333924]}}' },
            { title: "L2", geoJsonFeature: '{"type":"Feature","properties":{"title":"L2"},"geometry":{"type":"Point","coordinates":[-90.66718873564001,42.50363369819899]}}' },
            { title: "L3", geoJsonFeature: '{"type":"Feature","properties":{"title":"L3"},"geometry":{"type":"Point","coordinates":[-90.66712465078601,42.50364843018803]}}' },
            { title: "L4", geoJsonFeature: '{"type":"Feature","properties":{"title":"L4"},"geometry":{"type":"Point","coordinates":[-90.66707459225131,42.50366545692177]}}' },
            { title: "L6", geoJsonFeature: '{"type":"Feature","properties":{"title":"L6"},"geometry":{"type":"Point","coordinates":[-90.66729721601808,42.50368808173135]}}' },
            { title: "L7", geoJsonFeature: '{"type":"Feature","properties":{"title":"L7"},"geometry":{"type":"Point","coordinates":[-90.66722974034941,42.50370656187752]}}' },
            { title: "L8", geoJsonFeature: '{"type":"Feature","properties":{"title":"L8"},"geometry":{"type":"Point","coordinates":[-90.66717220108242,42.5037275258308]}}' }
        ];

        const MOCK_POIS = [
            // Public Parking - Based on actual boundary points
            { 
                title: "Public Parking", 
                poiType: "PublicParkingArea", 
                description: "Free public parking available during market hours.",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Public Parking","poiType":"PublicParkingArea"},"geometry":{"type":"Polygon","coordinates":[[[-90.66804340889776,42.50446505118786],[-90.66841324638393,42.50437012765608],[-90.66867547287909,42.50485333601699],[-90.66862384690215,42.50506574884043],[-90.66839353402308,42.50512629044432],[-90.66852712454524,42.50491062960312],[-90.66804340889776,42.50446505118786]]]}}'
            },
            // Vendor Parking - Based on actual boundary points
            { 
                title: "Vendor Parking", 
                poiType: "VendorParkingArea", 
                description: "Reserved for vendor loading and unloading. Please do not park here.",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Vendor Parking","poiType":"VendorParkingArea"},"geometry":{"type":"Polygon","coordinates":[[[-90.66683646349722,42.5036900229257],[-90.66650160354018,42.50378174999629],[-90.66613193866615,42.50311880376595],[-90.66646087997437,42.5030171700124],[-90.66683646349722,42.5036900229257]]]}}'
            },
            // Seating Area A - Based on actual boundary points
            { 
                title: "Seating Area - Main", 
                poiType: "SeatingArea", 
                description: "Shaded seating area with picnic tables. Enjoy your market finds here!",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Seating Area - Main","poiType":"SeatingArea"},"geometry":{"type":"Polygon","coordinates":[[[-90.6673580348103,42.50447437487957],[-90.66767472616625,42.50438333459344],[-90.66763219579437,42.50429307145564],[-90.6673202730374,42.50438238563299],[-90.6673580348103,42.50447437487957]]]}}'
            },
            // Seating Area B - Food Court area
            { 
                title: "Seating Area - Food Court", 
                poiType: "SeatingArea", 
                description: "Food court seating near the music stage.",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Seating Area - Food Court","poiType":"SeatingArea"},"geometry":{"type":"Polygon","coordinates":[[[-90.66734460121454,42.50481565143973],[-90.66723469231222,42.50485600153407],[-90.6672777631299,42.50494222477153],[-90.6674021045219,42.50490168077986],[-90.66734460121454,42.50481565143973]]]}}'
            },
            // Market Tokens / Money Booth (B22)
            { 
                title: "Market Tokens & SNAP/EBT", 
                poiType: "Market Tokens", 
                description: "Exchange SNAP/EBT benefits for market tokens. Double Up Food Bucks available! Match up to $20.",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Market Tokens & SNAP/EBT","poiType":"Market Tokens"},"geometry":{"type":"Point","coordinates":[-90.667719884841,42.50431974391505]}}'
            },
            // Restrooms - City Hall
            { 
                title: "Restrooms - City Hall", 
                poiType: "Restroom", 
                description: "Public restrooms available during market hours (7am - 12pm).",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Restrooms - City Hall","poiType":"Restroom"},"geometry":{"type":"Point","coordinates":[-90.66802843922088,42.50516284746323]}}'
            },
            // ATM
            { 
                title: "ATM - Iowa St. Market", 
                poiType: "Information", 
                description: "ATM available for cash withdrawals.",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"ATM - Iowa St. Market","poiType":"Information"},"geometry":{"type":"Point","coordinates":[-90.66796714145778,42.50489443082611]}}'
            },
            // Music / Food Court Stage
            { 
                title: "Live Music & Food Court", 
                poiType: "Special Event", 
                description: "Live local music every Saturday from 8am - 11am. Food vendors nearby!",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Live Music & Food Court","poiType":"Special Event"},"geometry":{"type":"Point","coordinates":[-90.66721927595437,42.50488055281747]}}'
            },
            // NFP Booth
            { 
                title: "Non-Profit Booth", 
                poiType: "Information", 
                description: "Community non-profit organizations booth.",
                geoJsonFeature: '{"type":"Feature","properties":{"title":"Non-Profit Booth","poiType":"Information"},"geometry":{"type":"Point","coordinates":[-90.66786551472161,42.50455437397706]}}'
            }
        ];

        const MOCK_VENDORS = [
            // Block A Vendors (southern section)
            { 
                _id: "v1", 
                title: "Happy Acres Farm", 
                vendorType: "Grower/Producer/Processor", 
                description: "Family farm growing seasonal vegetables, culinary herbs, and beautiful cut flowers using sustainable practices since 1998.", 
                arraystring: "vegetables, tomatoes, peppers, zucchini, herbs, basil, flowers, sunflowers, organic, sustainable",
                url: "https://happyacresfarm.com",
                StallList: ["A1", "A3"] 
            },
            { 
                _id: "v2", 
                title: "Sunrise Bakery", 
                vendorType: "Grower/Producer/Processor", 
                description: "Artisan sourdough breads, flaky pastries, and homemade fruit pies baked fresh every market morning.", 
                arraystring: "bread, sourdough, pastry, croissant, pie, apple pie, cookies, baked goods",
                url: "https://sunrisebakerydbq.com",
                StallList: ["A4", "A5"] 
            },
            { 
                _id: "v3", 
                title: "Mud River Coffee", 
                vendorType: "On-site Prepared Food Vendor", 
                description: "Locally roasted small-batch coffee. Espresso drinks, cold brew, and fresh pastries. Beans available by the pound!", 
                arraystring: "coffee, espresso, latte, cappuccino, cold brew, beans, roaster, breakfast",
                StallList: ["G1"] 
            },
            { 
                _id: "v4", 
                title: "Riverside Apiaries", 
                vendorType: "Grower/Producer/Processor", 
                description: "Raw local honey, creamed honey, beeswax candles, and natural lip balms. Our bees forage the Driftless hills.", 
                arraystring: "honey, raw honey, beeswax, candles, lip balm, natural, bees",
                StallList: ["A6", "A7"] 
            },
            // Block B Vendors (middle-south section)
            { 
                _id: "v5", 
                title: "Maria's Kitchen", 
                vendorType: "On-site Prepared Food Vendor", 
                description: "Authentic street tacos, breakfast burritos, and fresh-made salsas. Vegetarian options available!", 
                arraystring: "tacos, burritos, mexican, salsa, breakfast burrito, vegetarian, prepared food",
                StallList: ["B2", "B3"] 
            },
            { 
                _id: "v6", 
                title: "Driftless Pottery", 
                vendorType: "Crafter/Artisan", 
                description: "Handcrafted stoneware pottery - functional art for your kitchen and home. Each piece is unique.", 
                arraystring: "pottery, ceramic, stoneware, mugs, bowls, handmade, art, kitchen",
                url: "https://driftlesspottery.com",
                StallList: ["K1"] 
            },
            { 
                _id: "v7", 
                title: "Green Valley Meats", 
                vendorType: "Grower/Producer/Processor", 
                description: "Pasture-raised beef, heritage pork, and free-range chicken. No antibiotics, no hormones, just quality meat.", 
                arraystring: "beef, pork, chicken, bacon, sausage, meat, pasture-raised, grass-fed",
                StallList: ["D1", "D2"] 
            },
            { 
                _id: "v8", 
                title: "Berry Good Farm", 
                vendorType: "Grower/Producer/Processor", 
                description: "U-pick and pre-picked seasonal berries. Homemade jams, fruit preserves, and berry pies in season.", 
                arraystring: "berries, strawberries, blueberries, raspberries, jam, preserves, fruit, pie",
                StallList: ["A10", "A11"] 
            },
            // Block G Vendors (center section)
            { 
                _id: "v9", 
                title: "Kettle Creek Produce", 
                vendorType: "Grower/Producer/Processor", 
                description: "Certified organic vegetables and microgreens. Weekly CSA shares available - sign up at our booth!", 
                arraystring: "vegetables, organic, microgreens, lettuce, kale, spinach, CSA, certified organic",
                StallList: ["G5", "G6"] 
            },
            { 
                _id: "v10", 
                title: "The Crepe Cart", 
                vendorType: "On-site Prepared Food Vendor", 
                description: "Sweet and savory crepes made to order. Nutella, fresh fruit, ham & cheese, and seasonal specials!", 
                arraystring: "crepes, breakfast, nutella, sweet, savory, french, prepared food",
                StallList: ["H1", "H2"] 
            },
            { 
                _id: "v11", 
                title: "Prairie Fire Peppers", 
                vendorType: "Grower/Producer/Processor", 
                description: "Hot peppers, mild peppers, and everything in between. Homemade hot sauces and pepper jelly.", 
                arraystring: "peppers, hot sauce, jalapeno, habanero, ghost pepper, jelly, spicy",
                StallList: ["L1", "L2"] 
            },
            // Block J Vendors (north section)
            { 
                _id: "v12", 
                title: "Heartland Flowers", 
                vendorType: "Grower/Producer/Processor", 
                description: "Fresh cut flowers, bouquets, and potted plants from our family greenhouse.", 
                arraystring: "flowers, bouquets, plants, sunflowers, roses, fresh cut, greenhouse",
                StallList: ["J1", "J2"] 
            },
            { 
                _id: "v13", 
                title: "Dubuque Cheese Co.", 
                vendorType: "Grower/Producer/Processor", 
                description: "Artisan cheeses, fresh curds, and dairy products made right here in the Driftless.", 
                arraystring: "cheese, dairy, curds, cheddar, gouda, artisan, local",
                url: "https://dubuquecheese.com",
                StallList: ["C1", "C2"] 
            },
            { 
                _id: "v14", 
                title: "Iowa Prairie Candles", 
                vendorType: "Crafter/Artisan", 
                description: "Hand-poured soy candles with natural fragrances. Each candle burns clean for 40+ hours.", 
                arraystring: "candles, soy, handmade, fragrance, gift, home decor",
                StallList: ["K6", "K7"] 
            },
            { 
                _id: "v15", 
                title: "Mississippi River BBQ", 
                vendorType: "On-site Prepared Food Vendor", 
                description: "Slow-smoked ribs, pulled pork, and brisket. Award-winning sauces available by the bottle!", 
                arraystring: "bbq, barbecue, ribs, pulled pork, brisket, smoked, meat",
                StallList: ["H10", "H11", "H12"] 
            }
        ];

        // ============================================================
        // CONSTANTS
        // ============================================================
        const VENDOR_TYPE_COLORS = {
            "Grower/Producer/Processor": "#2D8B4E",
            "On-site Prepared Food Vendor": "#C76832",
            "Crafter/Artisan": "#5B6AAF",
            "Default": "#6B7280"
        };
        
        const POI_CONFIG = {
            "publicparkingarea": { color: "#E8B930", icon: "fa-square-parking" },
            "vendorparkingarea": { color: "#8B7355", icon: "fa-truck" },
            "restroom": { color: "#C75B39", icon: "fa-restroom" },
            "information": { color: "#3D7EAA", icon: "fa-circle-info" },
            "market tokens": { color: "#D4A84B", icon: "fa-coins" },
            "seatingarea": { color: "#8B4A6B", icon: "fa-chair" },
            "special event": { color: "#9B59B6", icon: "fa-music" }
        };
        
        const VENDOR_ICONS = [
            { keywords: ["coffee", "espresso", "latte"], icon: "fa-mug-hot" },
            { keywords: ["bread", "bakery", "pastry", "pie"], icon: "fa-bread-slice" },
            { keywords: ["honey", "beeswax"], icon: "fa-jar" },
            { keywords: ["taco", "mexican", "burrito"], icon: "fa-pepper-hot" },
            { keywords: ["pottery", "ceramic"], icon: "fa-paintbrush" },
            { keywords: ["meat", "beef", "pork", "chicken", "bbq", "barbecue", "ribs", "brisket"], icon: "fa-drumstick-bite" },
            { keywords: ["berry", "fruit", "apple"], icon: "fa-apple-whole" },
            { keywords: ["vegetable", "produce", "tomato", "lettuce", "organic", "microgreens"], icon: "fa-carrot" },
            { keywords: ["crepe", "breakfast"], icon: "fa-stroopwafel" },
            { keywords: ["pepper", "hot sauce", "spicy"], icon: "fa-fire" },
            { keywords: ["flower", "bouquet", "plants"], icon: "fa-seedling" },
            { keywords: ["cheese", "dairy", "curds"], icon: "fa-cheese" },
            { keywords: ["candle", "soy", "fragrance"], icon: "fa-fire-flame-curved" }
        ];
        
        const MARKER_SIZE = 38;
        const POI_SIZE = 32;
        const PILL_HEIGHT = 26;

        // ============================================================
        // STATE
        // ============================================================
        let map, vendorLayer, poiLayer, stallLayer;
        let stallMap = new Map();
        let vendorRefs = {}, poiRefs = {};
        let currentFilter = null, searchTerm = "";

        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupGeolocation();
            updateStatus("Click 'Load Map' to begin");
        });

        // Market "home" bounds - the default view area (based on actual GeoJSON data)
        const MARKET_CENTER = [42.5042, -90.6675];
        const MARKET_DEFAULT_ZOOM = 17;

        function initMap() {
            // Center on Dubuque Upper Main District
            map = L.map('map', {
                center: MARKET_CENTER,
                zoom: MARKET_DEFAULT_ZOOM,
                zoomControl: true,
                // Smooth out scroll wheel zoom - higher value = slower zoom
                wheelPxPerZoomLevel: 120,
                zoomSnap: 0.5,
                zoomDelta: 0.5
            });
            
            // Use a clean, modern map style
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20,
                minZoom: 14
            }).addTo(map);
            
            stallLayer = L.layerGroup().addTo(map);
            poiLayer = L.layerGroup().addTo(map);
            vendorLayer = L.layerGroup().addTo(map);
        }

        // ============================================================
        // DATA RENDERING
        // ============================================================
        function loadMockData() {
            document.getElementById('load-btn').classList.add('active');
            updateStatus("Loading...");
            
            stallLayer.clearLayers();
            poiLayer.clearLayers();
            vendorLayer.clearLayers();
            stallMap.clear();
            vendorRefs = {};
            poiRefs = {};

            // 1. Render stall positions (subtle dots)
            MOCK_STALL_LAYOUTS.forEach(stall => {
                const feature = JSON.parse(stall.geoJsonFeature);
                stallMap.set(stall.title, feature);
                
                const coords = feature.geometry.coordinates;
                L.circleMarker([coords[1], coords[0]], {
                    radius: 4,
                    fillColor: "#9CA3AF",
                    fillOpacity: 0.4,
                    stroke: true,
                    color: "#6B7280",
                    weight: 1
                }).addTo(stallLayer);
            });

            // 2. Render POIs
            MOCK_POIS.forEach(poi => {
                const feature = JSON.parse(poi.geoJsonFeature);
                const poiTypeLower = (poi.poiType || "").toLowerCase();
                const config = POI_CONFIG[poiTypeLower] || { color: "#6B7280", icon: "fa-circle-info" };
                const isDimmed = (currentFilter || searchTerm) && !matchesPOI(poi);

                if (feature.geometry.type === "Polygon") {
                    const coords = feature.geometry.coordinates[0].map(c => [c[1], c[0]]);
                    const polygon = L.polygon(coords, {
                        fillColor: config.color,
                        fillOpacity: isDimmed ? 0.05 : 0.2,
                        color: config.color,
                        weight: 2,
                        opacity: isDimmed ? 0.3 : 0.8
                    }).addTo(poiLayer);
                    
                    polygon.bindPopup(createPOIPopup(poi), { className: '' });
                    poiRefs[poi.title] = { layer: polygon, data: poi };
                } else {
                    const coords = feature.geometry.coordinates;
                    const marker = L.marker([coords[1], coords[0]], {
                        icon: createPOIIcon(config, isDimmed)
                    }).addTo(poiLayer);
                    
                    marker.bindPopup(createPOIPopup(poi), { className: '' });
                    poiRefs[poi.title] = { layer: marker, data: poi };
                }
            });

            // 3. Render vendors
            MOCK_VENDORS.forEach(vendor => {
                if (!vendor.StallList?.length) return;
                
                const blocks = groupStalls(vendor.StallList);
                blocks.forEach(block => {
                    const features = block.map(id => stallMap.get(id)).filter(f => f);
                    if (!features.length) return;

                    const isMatch = matchesVendor(vendor);
                    const isDimmed = (currentFilter || searchTerm) && !isMatch;

                    let latlng;
                    if (features.length > 1) {
                        const coords = features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0]]);
                        latlng = L.latLngBounds(coords).getCenter();
                    } else {
                        latlng = L.latLng(features[0].geometry.coordinates[1], features[0].geometry.coordinates[0]);
                    }

                    const marker = L.marker(latlng, {
                        icon: createVendorIcon(vendor, features.length > 1, isDimmed),
                        zIndexOffset: isDimmed ? 0 : 100
                    }).addTo(vendorLayer);

                    marker.bindPopup(createVendorPopup(vendor, block), { className: '', maxWidth: 320 });
                    vendorRefs[vendor.title] = { marker, vendor, block };
                });
            });

            fitAllMarkers();
            updateStatus(`${MOCK_VENDORS.length} vendors loaded`);
        }

        // ============================================================
        // ICON CREATION
        // ============================================================
        function createVendorIcon(vendor, isMultiStall, isDimmed) {
            const color = VENDOR_TYPE_COLORS[vendor.vendorType] || VENDOR_TYPE_COLORS.Default;
            const iconClass = getVendorIcon(vendor);
            const opacity = isDimmed ? 0.35 : 1;
            
            if (isMultiStall) {
                const width = 50;
                return L.divIcon({
                    className: '',
                    html: `<div class="multi-stall-marker ${isDimmed ? 'dimmed' : ''}" style="width:${width}px;height:${PILL_HEIGHT}px;background:${color};opacity:${opacity}">
                        <i class="fa-solid ${iconClass}" style="font-size:13px;color:white"></i>
                    </div>`,
                    iconSize: [width, PILL_HEIGHT],
                    iconAnchor: [width/2, PILL_HEIGHT/2],
                    popupAnchor: [0, -PILL_HEIGHT/2 - 5]
                });
            }
            
            return L.divIcon({
                className: '',
                html: `<div class="vendor-marker ${isDimmed ? 'dimmed' : ''}" style="width:${MARKER_SIZE}px;height:${MARKER_SIZE}px;background:${color};opacity:${opacity}">
                    <i class="fa-solid ${iconClass}" style="font-size:15px"></i>
                </div>`,
                iconSize: [MARKER_SIZE, MARKER_SIZE],
                iconAnchor: [MARKER_SIZE/2, MARKER_SIZE/2],
                popupAnchor: [0, -MARKER_SIZE/2 - 5]
            });
        }

        function createPOIIcon(config, isDimmed) {
            const opacity = isDimmed ? 0.35 : 1;
            return L.divIcon({
                className: '',
                html: `<div class="poi-marker ${isDimmed ? 'dimmed' : ''}" style="width:${POI_SIZE}px;height:${POI_SIZE}px;background:${config.color};opacity:${opacity}">
                    <i class="fa-solid ${config.icon}" style="font-size:14px;color:white"></i>
                </div>`,
                iconSize: [POI_SIZE, POI_SIZE],
                iconAnchor: [POI_SIZE/2, POI_SIZE/2],
                popupAnchor: [0, -POI_SIZE/2 - 5]
            });
        }

        function getVendorIcon(vendor) {
            const text = [vendor.title, vendor.description, vendor.arraystring].join(' ').toLowerCase();
            for (const cfg of VENDOR_ICONS) {
                if (cfg.keywords.some(kw => text.includes(kw))) return cfg.icon;
            }
            return 'fa-store';
        }

        // ============================================================
        // POPUP CREATION
        // ============================================================
        function createVendorPopup(vendor, stalls) {
            const color = VENDOR_TYPE_COLORS[vendor.vendorType] || VENDOR_TYPE_COLORS.Default;
            const icon = getVendorIcon(vendor);
            const tags = vendor.arraystring ? vendor.arraystring.split(',').slice(0, 5).map(t => 
                `<span class="popup-tag">${t.trim()}</span>`
            ).join('') : '';
            
            return `
                <div class="popup-card">
                    <div class="popup-header">
                        <div class="popup-title">${vendor.title}</div>
                        <span class="popup-badge" style="background:${color}">
                            <i class="fa-solid ${icon}"></i>
                            ${vendor.vendorType.replace('Grower/Producer/Processor', 'Farm Fresh').replace('On-site Prepared Food Vendor', 'Ready to Eat').replace('Crafter/Artisan', 'Artisan')}
                        </span>
                        <div class="popup-stalls"><i class="fa-solid fa-location-dot"></i> Stalls: ${stalls.join(', ')}</div>
                    </div>
                    <div class="popup-body">
                        <p class="popup-description">${vendor.description}</p>
                        ${tags ? `<div class="popup-tags">${tags}</div>` : ''}
                    </div>
                    <div class="popup-footer">
                        ${vendor.url ? `<a href="${vendor.url}" target="_blank" class="popup-btn popup-btn-secondary"><i class="fa-solid fa-globe"></i> Website</a>` : ''}
                        <a href="#" class="popup-btn popup-btn-primary"><i class="fa-solid fa-diamond-turn-right"></i> Directions</a>
                    </div>
                </div>
            `;
        }

        function createPOIPopup(poi) {
            const poiType = (poi.poiType || "").toLowerCase();
            const config = POI_CONFIG[poiType] || { color: "#6B7280", icon: "fa-circle-info" };
            
            return `
                <div class="popup-card">
                    <div class="popup-header">
                        <div class="popup-title">${poi.title}</div>
                        <span class="popup-badge" style="background:${config.color}">
                            <i class="fa-solid ${config.icon}"></i>
                            ${poi.poiType}
                        </span>
                    </div>
                    <div class="popup-body">
                        <p class="popup-description">${poi.description}</p>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // FILTERING
        // ============================================================
        function filterByType(type) {
            currentFilter = { type: 'vendorType', value: type };
            searchTerm = "";
            document.getElementById('search-input').value = "";
            updateAllButtons();
            refreshMarkerStyles();
            updateStatus(`Filter: ${type.includes('Grower') ? 'Farm Fresh' : type.includes('Prepared') ? 'Ready to Eat' : 'Artisan'}`);
        }

        function filterByKeyword(keyword) {
            currentFilter = { type: 'keyword', value: keyword };
            searchTerm = "";
            document.getElementById('search-input').value = "";
            updateAllButtons();
            refreshMarkerStyles();
            updateStatus(`Filter: ${keyword}`);
        }

        function handleSearch(term) {
            searchTerm = term.trim().toLowerCase();
            currentFilter = null;
            updateAllButtons();
            refreshMarkerStyles();
            updateStatus(term ? `Search: "${term}"` : "Search cleared");
        }

        function clearFilters() {
            currentFilter = null;
            searchTerm = "";
            document.getElementById('search-input').value = "";
            updateAllButtons();
            refreshMarkerStyles();
            updateStatus("Filters cleared");
        }

        function updateAllButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('load-btn').classList.add('active');
        }

        function refreshMarkerStyles() {
            Object.values(vendorRefs).forEach(({ marker, vendor, block }) => {
                const isMatch = matchesVendor(vendor);
                const isDimmed = (currentFilter || searchTerm) && !isMatch;
                const features = block.map(id => stallMap.get(id)).filter(f => f);
                marker.setIcon(createVendorIcon(vendor, features.length > 1, isDimmed));
                marker.setZIndexOffset(isDimmed ? 0 : 100);
            });
        }

        function matchesVendor(vendor) {
            if (!currentFilter && !searchTerm) return true;
            
            if (searchTerm) {
                const text = [vendor.title, vendor.description, vendor.arraystring].join(' ').toLowerCase();
                return text.includes(searchTerm);
            }
            
            if (currentFilter?.type === 'vendorType') {
                return vendor.vendorType === currentFilter.value;
            }
            if (currentFilter?.type === 'keyword') {
                const text = [vendor.title, vendor.description, vendor.arraystring].join(' ').toLowerCase();
                return text.includes(currentFilter.value.toLowerCase());
            }
            return true;
        }

        function matchesPOI(poi) {
            if (!currentFilter && !searchTerm) return true;
            if (searchTerm) {
                return [poi.title, poi.description, poi.poiType].join(' ').toLowerCase().includes(searchTerm);
            }
            return false;
        }

        // ============================================================
        // UTILITIES
        // ============================================================
        function groupStalls(list) {
            if (!list?.length) return [];
            if (list.length === 1) return [[list[0]]];
            
            const sorted = [...list].sort((a, b) => {
                const aNum = parseInt(a.replace(/\D/g, ''));
                const bNum = parseInt(b.replace(/\D/g, ''));
                return aNum - bNum;
            });
            
            const groups = [];
            let current = [sorted[0]];
            
            for (let i = 1; i < sorted.length; i++) {
                const prevNum = parseInt(sorted[i-1].replace(/\D/g, ''));
                const currNum = parseInt(sorted[i].replace(/\D/g, ''));
                
                if (currNum - prevNum === 1) {
                    current.push(sorted[i]);
                } else {
                    groups.push(current);
                    current = [sorted[i]];
                }
            }
            groups.push(current);
            return groups;
        }

        function fitAllMarkers() {
            // Return to market home view
            map.flyTo(MARKET_CENTER, MARKET_DEFAULT_ZOOM, { duration: 0.5 });
            updateStatus("Home view");
        }

        function setupGeolocation() {
            const btn = document.getElementById('locate-btn');
            if (!navigator.geolocation) {
                btn.style.display = 'none';
                return;
            }
            
            btn.addEventListener('click', () => {
                btn.classList.add('locating');
                updateStatus("Finding location...");
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        btn.classList.remove('locating');
                        const latlng = [pos.coords.latitude, pos.coords.longitude];
                        
                        L.marker(latlng, {
                            icon: L.divIcon({
                                className: '',
                                html: '<div class="user-location"></div>',
                                iconSize: [18, 18],
                                iconAnchor: [9, 9]
                            }),
                            zIndexOffset: 1000
                        }).addTo(map).bindPopup('<b>You are here</b>');
                        
                        map.flyTo(latlng, 18, { duration: 0.8 });
                        updateStatus("Location found!");
                    },
                    (err) => {
                        btn.classList.remove('locating');
                        updateStatus("Location unavailable");
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        function updateStatus(msg) {
            document.getElementById('status-text').textContent = msg;
        }
    </script>
</body>
</html>
