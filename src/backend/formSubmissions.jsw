import wixData from 'wix-data';
import wixCrmBackend from 'wix-crm-backend';
import { elevate } from 'wix-auth';

/**
 * Backend function to create a specialty profile and weekly assignments
 * This function has elevated permissions to insert into CMS collections
 * @param {Object} profileData - The profile data to save
 * @param {Array<string>} dateIds - Array of date IDs from MarketDates2026
 * @returns {Promise<Object>} Result object with success status and IDs
 */
export async function submitSpecialtyProfile(profileData, dateIds) {
	try {
		// Validate inputs
		if (!profileData) {
			throw new Error('Profile data is required');
		}
		if (!dateIds || dateIds.length === 0) {
			throw new Error('At least one date must be selected');
		}
		
		// Create or update Wix CRM contact for email notifications
		// This ensures the contact exists when we need to send approval/rejection emails
		// IMPORTANT: Use createContact with allowDuplicates to prevent reconciliation with admin's contact
		if (profileData.contactEmail) {
			try {
				console.log(`[FORM-SUBMISSION] Creating contact for: ${profileData.contactEmail}`);
				
				// First, check if contact already exists by email
				let existingContacts = await wixCrmBackend.contacts.queryContacts()
					.eq('primaryInfo.email', profileData.contactEmail)
					.limit(1)
					.find();
				
				// If not found by email, also check by name (to catch contacts created without emails)
				if ((!existingContacts.items || existingContacts.items.length === 0) && profileData.organizationName) {
					console.log(`[FORM-SUBMISSION] Not found by email, checking by name: ${profileData.organizationName}`);
					const nameSearch = await wixCrmBackend.contacts.queryContacts()
						.limit(100)
						.find();
					
					const matchingByName = nameSearch.items.filter(contact => {
						const firstName = contact.info?.name?.first || contact.name?.first || '';
						const lastName = contact.info?.name?.last || contact.name?.last || '';
						const fullName = `${firstName} ${lastName}`.trim();
						const orgName = profileData.organizationName.trim();
						
						// Check if name matches (exact or contains "Participant" suffix)
						return fullName.toLowerCase() === orgName.toLowerCase() ||
						       fullName.toLowerCase() === `${orgName} Participant`.toLowerCase() ||
						       (firstName.toLowerCase() === orgName.toLowerCase() && lastName === 'Participant');
					});
					
					if (matchingByName.length > 0) {
						existingContacts = { items: [matchingByName[0]] };
						console.log(`[FORM-SUBMISSION] Found existing contact by name: ${matchingByName[0]._id}`);
					}
				}
				
				if (existingContacts.items && existingContacts.items.length > 0) {
					const existingContact = existingContacts.items[0];
					const existingEmail = existingContact.info?.primaryEmail || 
					                     existingContact.primaryInfo?.email || '';
					
					console.log(`[FORM-SUBMISSION] Contact already exists: ${existingContact._id}, email: ${existingEmail || 'none'}`);
					
					// If contact exists but has no email, update it with the email
					if (!existingEmail && profileData.contactEmail) {
						console.log(`[FORM-SUBMISSION] Updating existing contact with email: ${profileData.contactEmail}`);
						try {
							const elevatedUpdateContact = elevate(wixCrmBackend.contacts.updateContact);
							const revision = existingContact.revision || existingContact.info?.revision || 1;
							await elevatedUpdateContact(existingContact._id, {
								emails: {
									items: [
										{
											email: profileData.contactEmail,
											primary: true
										}
									]
								}
							}, revision);
							console.log(`[FORM-SUBMISSION] âœ… Updated contact with email`);
						} catch (updateError) {
							console.warn(`[FORM-SUBMISSION] Could not update contact with email:`, updateError.message);
						}
					}
				} else {
					// Create new contact using createContact (not appendOrCreateContact to avoid reconciliation)
					// IMPORTANT: Use elevate() to grant required permissions for createContact
					try {
						console.log(`[FORM-SUBMISSION] Attempting to create contact for: ${profileData.contactEmail}`);
						const elevatedCreateContact = elevate(wixCrmBackend.contacts.createContact);
						// Use contactName if available, otherwise use organizationName
						const contactDisplayName = profileData.contactName || profileData.organizationName || 'Market';
						const newContact = await elevatedCreateContact({
							name: {
								first: contactDisplayName,
								last: 'Participant'
							},
							emails: {
								items: [
									{
										email: profileData.contactEmail,
										primary: true
									}
								]
							}
						}, {
							allowDuplicates: true // Force creation even if email exists elsewhere
						});
						console.log(`[FORM-SUBMISSION] âœ… Contact created successfully: ${newContact._id}`);
					} catch (createError) {
						// Log detailed error information
						console.error(`[FORM-SUBMISSION] âŒ createContact failed for ${profileData.contactEmail}:`, {
							message: createError.message,
							code: createError.details?.applicationError?.code,
							description: createError.details?.applicationError?.description,
							error: createError
						});
						
						// If createContact fails, try appendOrCreateContact as fallback
						console.warn(`[FORM-SUBMISSION] Trying appendOrCreateContact as fallback...`);
						try {
							// Use contactName if available, otherwise use organizationName
							const contactDisplayName = profileData.contactName || profileData.organizationName || 'Market';
							const fallbackContact = await wixCrmBackend.contacts.appendOrCreateContact({
								email: profileData.contactEmail,
								name: {
									first: contactDisplayName,
									last: 'Participant'
								},
								subscriptionStatus: 'NOT_SET'
							});
							console.log(`[FORM-SUBMISSION] âœ… Contact created via appendOrCreateContact: ${fallbackContact.contactId || 'ID not returned'}`);
							
							// Verify and update the contact email if needed
							if (fallbackContact && (fallbackContact.contactId || fallbackContact._id)) {
								const contactId = fallbackContact.contactId || fallbackContact._id;
								try {
									const verifyContact = await wixCrmBackend.contacts.getContact(contactId);
									const verifyEmail = verifyContact.info?.primaryEmail || 
									                   verifyContact.primaryInfo?.email || 
									                   verifyContact.email || '';
									
									if (!verifyEmail || verifyEmail.toLowerCase() !== profileData.contactEmail.toLowerCase()) {
										console.log(`[FORM-SUBMISSION] âš ï¸ Contact email is missing or incorrect. Updating contact with correct email...`);
										const elevatedUpdateContact = elevate(wixCrmBackend.contacts.updateContact);
										const revision = verifyContact.revision || verifyContact.info?.revision || 1;
										await elevatedUpdateContact(contactId, {
											emails: {
												items: [
													{
														email: profileData.contactEmail,
														primary: true
													}
												]
											}
										}, revision);
										console.log(`[FORM-SUBMISSION] âœ… Successfully updated contact with email: ${profileData.contactEmail}`);
									} else {
										console.log(`[FORM-SUBMISSION] âœ… Contact email verified: ${verifyEmail}`);
									}
								} catch (updateError) {
									console.warn(`[FORM-SUBMISSION] âš ï¸ Warning: Failed to verify/update contact email:`, updateError.message);
								}
							}
						} catch (appendError) {
							console.error(`[FORM-SUBMISSION] âŒ appendOrCreateContact also failed:`, {
								message: appendError.message,
								code: appendError.details?.applicationError?.code,
								description: appendError.details?.applicationError?.description
							});
							// Re-throw to be caught by outer catch block
							throw appendError;
						}
					}
				}
			} catch (contactError) {
				// Log detailed error but don't fail form submission
				console.error(`[FORM-SUBMISSION] âŒ CRITICAL: Failed to create contact for ${profileData.contactEmail}:`, {
					message: contactError.message,
					code: contactError.details?.applicationError?.code,
					description: contactError.details?.applicationError?.description,
					stack: contactError.stack
				});
				console.error(`[FORM-SUBMISSION] âš ï¸ Form submission will continue, but email notifications WILL FAIL for this contact.`);
				console.error(`[FORM-SUBMISSION] ðŸ’¡ SOLUTION: Manually create contact in Wix CRM or fix permissions issue.`);
			}
		}
		
		// Save the profile
		const profileResult = await wixData.save('SpecialtyProfiles', profileData);
		const profileId = profileResult._id;
		
		// Create weekly assignment records for each selected date
		const assignmentPromises = dateIds.map(async (dateId) => {
			return await wixData.save('WeeklyAssignments', {
				profileRef: profileId,
				dateRef: dateId,
				applicationStatus: 'Pending'
			});
		});
		
		await Promise.all(assignmentPromises);
		
		return {
			success: true,
			profileId: profileId,
			assignmentsCreated: dateIds.length
		};
	} catch (error) {
		console.error('Error in submitSpecialtyProfile:', error);
		throw error;
	}
}

/**
 * Backend function to manually create a specialty profile and weekly assignments
 * This is used for entering hard copy form submissions into the system
 * Same functionality as submitSpecialtyProfile but with optional CRM contact creation
 * @param {Object} profileData - The profile data to save
 * @param {Array<string>} dateIds - Array of date IDs from MarketDates2026
 * @param {boolean} createContact - Whether to create/update CRM contact (default: false for manual entries)
 * @returns {Promise<Object>} Result object with success status and IDs
 */
export async function manualEntrySpecialtyProfile(profileData, dateIds, createContact = false) {
	try {
		// Validate inputs
		if (!profileData) {
			throw new Error('Profile data is required');
		}
		if (!dateIds || dateIds.length === 0) {
			throw new Error('At least one date must be selected');
		}
		
		// Create or update Wix CRM contact for email notifications (only if requested)
		// For manual entries, we typically skip this unless email is provided and admin wants it
		if (createContact && profileData.contactEmail) {
			try {
				console.log(`[MANUAL-ENTRY] Creating contact for: ${profileData.contactEmail}`);
				
				// First, check if contact already exists by email
				let existingContacts = await wixCrmBackend.contacts.queryContacts()
					.eq('primaryInfo.email', profileData.contactEmail)
					.limit(1)
					.find();
				
				// If not found by email, also check by name (to catch contacts created without emails)
				if ((!existingContacts.items || existingContacts.items.length === 0) && profileData.organizationName) {
					console.log(`[MANUAL-ENTRY] Not found by email, checking by name: ${profileData.organizationName}`);
					const nameSearch = await wixCrmBackend.contacts.queryContacts()
						.limit(100)
						.find();
					
					const matchingByName = nameSearch.items.filter(contact => {
						const firstName = contact.info?.name?.first || contact.name?.first || '';
						const lastName = contact.info?.name?.last || contact.name?.last || '';
						const fullName = `${firstName} ${lastName}`.trim();
						const orgName = profileData.organizationName.trim();
						
						return fullName.toLowerCase() === orgName.toLowerCase() ||
						       fullName.toLowerCase() === `${orgName} Participant`.toLowerCase() ||
						       (firstName.toLowerCase() === orgName.toLowerCase() && lastName === 'Participant');
					});
					
					if (matchingByName.length > 0) {
						existingContacts = { items: [matchingByName[0]] };
						console.log(`[MANUAL-ENTRY] Found existing contact by name: ${matchingByName[0]._id}`);
					}
				}
				
				if (existingContacts.items && existingContacts.items.length > 0) {
					const existingContact = existingContacts.items[0];
					const existingEmail = existingContact.info?.primaryEmail || 
					                     existingContact.primaryInfo?.email || '';
					
					console.log(`[MANUAL-ENTRY] Contact already exists: ${existingContact._id}, email: ${existingEmail || 'none'}`);
					
					// If contact exists but has no email, update it with the email
					if (!existingEmail && profileData.contactEmail) {
						console.log(`[MANUAL-ENTRY] Updating existing contact with email: ${profileData.contactEmail}`);
						try {
							const elevatedUpdateContact = elevate(wixCrmBackend.contacts.updateContact);
							const revision = existingContact.revision || existingContact.info?.revision || 1;
							await elevatedUpdateContact(existingContact._id, {
								emails: {
									items: [
										{
											email: profileData.contactEmail,
											primary: true
										}
									]
								}
							}, revision);
							console.log(`[MANUAL-ENTRY] âœ… Updated contact with email`);
						} catch (updateError) {
							console.warn(`[MANUAL-ENTRY] Could not update contact with email:`, updateError.message);
						}
					}
				} else {
					// Create new contact
					// IMPORTANT: Use elevate() to grant required permissions for createContact
					try {
						const elevatedCreateContact = elevate(wixCrmBackend.contacts.createContact);
						// Use contactName if available, otherwise use organizationName
						const contactDisplayName = profileData.contactName || profileData.organizationName || 'Market';
						await elevatedCreateContact({
							name: {
								first: contactDisplayName,
								last: 'Participant'
							},
							emails: {
								items: [
									{
										email: profileData.contactEmail,
										primary: true
									}
								]
							}
						}, {
							allowDuplicates: true
						});
						console.log(`[MANUAL-ENTRY] Contact created successfully`);
					} catch (createError) {
						console.warn(`[MANUAL-ENTRY] createContact failed, trying appendOrCreateContact:`, createError.message);
						// Use contactName if available, otherwise use organizationName
						const contactDisplayName = profileData.contactName || profileData.organizationName || 'Market';
						const fallbackContact = await wixCrmBackend.contacts.appendOrCreateContact({
							email: profileData.contactEmail,
							name: {
								first: contactDisplayName,
								last: 'Participant'
							},
							subscriptionStatus: 'NOT_SET'
						});
						console.log(`[MANUAL-ENTRY] Contact created via appendOrCreateContact`);
						
						// Verify and update email if needed
						if (fallbackContact && (fallbackContact.contactId || fallbackContact._id)) {
							const contactId = fallbackContact.contactId || fallbackContact._id;
							try {
								const verifyContact = await wixCrmBackend.contacts.getContact(contactId);
								const verifyEmail = verifyContact.info?.primaryEmail || 
								                   verifyContact.primaryInfo?.email || 
								                   verifyContact.email || '';
								
								if (!verifyEmail || verifyEmail.toLowerCase() !== profileData.contactEmail.toLowerCase()) {
									console.log(`[MANUAL-ENTRY] âš ï¸ Contact email is missing or incorrect. Updating contact with correct email...`);
									const elevatedUpdateContact = elevate(wixCrmBackend.contacts.updateContact);
									const revision = verifyContact.revision || verifyContact.info?.revision || 1;
									await elevatedUpdateContact(contactId, {
										emails: {
											items: [
												{
													email: profileData.contactEmail,
													primary: true
												}
											]
										}
									}, revision);
									console.log(`[MANUAL-ENTRY] âœ… Successfully updated contact with email: ${profileData.contactEmail}`);
								}
							} catch (updateError) {
								console.warn(`[MANUAL-ENTRY] âš ï¸ Warning: Failed to verify/update contact email:`, updateError.message);
							}
						}
					}
				}
			} catch (contactError) {
				// Don't fail manual entry if contact creation fails
				console.warn(`[MANUAL-ENTRY] Warning: Failed to create contact:`, contactError.message);
			}
		}
		
		// Save the profile
		const profileResult = await wixData.save('SpecialtyProfiles', profileData);
		const profileId = profileResult._id;
		
		// Create weekly assignment records for each selected date
		const assignmentPromises = dateIds.map(async (dateId) => {
			return await wixData.save('WeeklyAssignments', {
				profileRef: profileId,
				dateRef: dateId,
				applicationStatus: 'Pending'
			});
		});
		
		await Promise.all(assignmentPromises);
		
		return {
			success: true,
			profileId: profileId,
			assignmentsCreated: dateIds.length
		};
	} catch (error) {
		console.error('Error in manualEntrySpecialtyProfile:', error);
		throw error;
	}
}
