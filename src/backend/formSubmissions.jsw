import wixData from 'wix-data';
import wixCrmBackend from 'wix-crm-backend';

/**
 * Backend function to create a specialty profile and weekly assignments
 * This function has elevated permissions to insert into CMS collections
 * @param {Object} profileData - The profile data to save
 * @param {Array<string>} dateIds - Array of date IDs from MarketDates2026
 * @returns {Promise<Object>} Result object with success status and IDs
 */
export async function submitSpecialtyProfile(profileData, dateIds) {
	try {
		// Validate inputs
		if (!profileData) {
			throw new Error('Profile data is required');
		}
		if (!dateIds || dateIds.length === 0) {
			throw new Error('At least one date must be selected');
		}
		
		// Create or update Wix CRM contact for email notifications
		// This ensures the contact exists when we need to send approval/rejection emails
		// IMPORTANT: Use createContact with allowDuplicates to prevent reconciliation with admin's contact
		if (profileData.contactEmail) {
			try {
				console.log(`[FORM-SUBMISSION] Creating contact for: ${profileData.contactEmail}`);
				
				// First, check if contact already exists
				const existingContacts = await wixCrmBackend.contacts.queryContacts()
					.eq('primaryInfo.email', profileData.contactEmail)
					.limit(1)
					.find();
				
				if (existingContacts.items && existingContacts.items.length > 0) {
					console.log(`[FORM-SUBMISSION] Contact already exists: ${existingContacts.items[0]._id}`);
					// Update subscription status if needed
					try {
						await wixCrmBackend.contacts.updateContact(existingContacts.items[0]._id, {
							subscriptionStatus: 'NOT_SET'
						});
						console.log(`[FORM-SUBMISSION] Updated subscription status to NOT_SET`);
					} catch (updateError) {
						console.warn(`[FORM-SUBMISSION] Could not update subscription status:`, updateError.message);
					}
				} else {
					// Create new contact using createContact (not appendOrCreateContact to avoid reconciliation)
					try {
						console.log(`[FORM-SUBMISSION] Attempting to create contact for: ${profileData.contactEmail}`);
						const newContact = await wixCrmBackend.contacts.createContact({
							primaryInfo: {
								email: profileData.contactEmail
							},
							name: {
								first: profileData.organizationName || 'Market',
								last: 'Participant'
							},
							subscriptionStatus: 'NOT_SET' // Allow emails to be sent
						}, {
							allowDuplicates: true // Force creation even if email exists elsewhere
						});
						console.log(`[FORM-SUBMISSION] âœ… Contact created successfully: ${newContact._id}`);
					} catch (createError) {
						// Log detailed error information
						console.error(`[FORM-SUBMISSION] âŒ createContact failed for ${profileData.contactEmail}:`, {
							message: createError.message,
							code: createError.details?.applicationError?.code,
							description: createError.details?.applicationError?.description,
							error: createError
						});
						
						// If createContact fails, try appendOrCreateContact as fallback
						console.warn(`[FORM-SUBMISSION] Trying appendOrCreateContact as fallback...`);
						try {
							const fallbackContact = await wixCrmBackend.contacts.appendOrCreateContact({
								email: profileData.contactEmail,
								name: {
									first: profileData.organizationName || 'Market',
									last: 'Participant'
								},
								subscriptionStatus: 'NOT_SET'
							});
							console.log(`[FORM-SUBMISSION] âœ… Contact created via appendOrCreateContact: ${fallbackContact.contactId || 'ID not returned'}`);
							
							// Verify the contact was created with correct email
							if (fallbackContact.contactId) {
								const verifyContact = await wixCrmBackend.contacts.getContact(fallbackContact.contactId);
								const verifyEmail = verifyContact.info?.primaryEmail || verifyContact.primaryInfo?.email;
								if (verifyEmail && verifyEmail.toLowerCase() !== profileData.contactEmail.toLowerCase()) {
									console.error(`[FORM-SUBMISSION] âš ï¸ WARNING: Contact email mismatch! Expected ${profileData.contactEmail}, got ${verifyEmail}`);
									console.error(`[FORM-SUBMISSION] This may indicate appendOrCreateContact reconciled with admin's contact.`);
								}
							}
						} catch (appendError) {
							console.error(`[FORM-SUBMISSION] âŒ appendOrCreateContact also failed:`, {
								message: appendError.message,
								code: appendError.details?.applicationError?.code,
								description: appendError.details?.applicationError?.description
							});
							// Re-throw to be caught by outer catch block
							throw appendError;
						}
					}
				}
			} catch (contactError) {
				// Log detailed error but don't fail form submission
				console.error(`[FORM-SUBMISSION] âŒ CRITICAL: Failed to create contact for ${profileData.contactEmail}:`, {
					message: contactError.message,
					code: contactError.details?.applicationError?.code,
					description: contactError.details?.applicationError?.description,
					stack: contactError.stack
				});
				console.error(`[FORM-SUBMISSION] âš ï¸ Form submission will continue, but email notifications WILL FAIL for this contact.`);
				console.error(`[FORM-SUBMISSION] ðŸ’¡ SOLUTION: Manually create contact in Wix CRM or fix permissions issue.`);
			}
		}
		
		// Save the profile
		const profileResult = await wixData.save('SpecialtyProfiles', profileData);
		const profileId = profileResult._id;
		
		// Create weekly assignment records for each selected date
		const assignmentPromises = dateIds.map(async (dateId) => {
			return await wixData.save('WeeklyAssignments', {
				profileRef: profileId,
				dateRef: dateId,
				applicationStatus: 'Pending'
			});
		});
		
		await Promise.all(assignmentPromises);
		
		return {
			success: true,
			profileId: profileId,
			assignmentsCreated: dateIds.length
		};
	} catch (error) {
		console.error('Error in submitSpecialtyProfile:', error);
		throw error;
	}
}

/**
 * Backend function to manually create a specialty profile and weekly assignments
 * This is used for entering hard copy form submissions into the system
 * Same functionality as submitSpecialtyProfile but with optional CRM contact creation
 * @param {Object} profileData - The profile data to save
 * @param {Array<string>} dateIds - Array of date IDs from MarketDates2026
 * @param {boolean} createContact - Whether to create/update CRM contact (default: false for manual entries)
 * @returns {Promise<Object>} Result object with success status and IDs
 */
export async function manualEntrySpecialtyProfile(profileData, dateIds, createContact = false) {
	try {
		// Validate inputs
		if (!profileData) {
			throw new Error('Profile data is required');
		}
		if (!dateIds || dateIds.length === 0) {
			throw new Error('At least one date must be selected');
		}
		
		// Create or update Wix CRM contact for email notifications (only if requested)
		// For manual entries, we typically skip this unless email is provided and admin wants it
		if (createContact && profileData.contactEmail) {
			try {
				console.log(`[MANUAL-ENTRY] Creating contact for: ${profileData.contactEmail}`);
				
				// First, check if contact already exists
				const existingContacts = await wixCrmBackend.contacts.queryContacts()
					.eq('primaryInfo.email', profileData.contactEmail)
					.limit(1)
					.find();
				
				if (existingContacts.items && existingContacts.items.length > 0) {
					console.log(`[MANUAL-ENTRY] Contact already exists: ${existingContacts.items[0]._id}`);
					// Update subscription status if needed
					try {
						await wixCrmBackend.contacts.updateContact(existingContacts.items[0]._id, {
							subscriptionStatus: 'NOT_SET'
						});
						console.log(`[MANUAL-ENTRY] Updated subscription status to NOT_SET`);
					} catch (updateError) {
						console.warn(`[MANUAL-ENTRY] Could not update subscription status:`, updateError.message);
					}
				} else {
					// Create new contact
					try {
						await wixCrmBackend.contacts.createContact({
							primaryInfo: {
								email: profileData.contactEmail
							},
							name: {
								first: profileData.organizationName || 'Market',
								last: 'Participant'
							},
							subscriptionStatus: 'NOT_SET'
						}, {
							allowDuplicates: true
						});
						console.log(`[MANUAL-ENTRY] Contact created successfully`);
					} catch (createError) {
						console.warn(`[MANUAL-ENTRY] createContact failed, trying appendOrCreateContact:`, createError.message);
						await wixCrmBackend.contacts.appendOrCreateContact({
							email: profileData.contactEmail,
							name: {
								first: profileData.organizationName || 'Market',
								last: 'Participant'
							},
							subscriptionStatus: 'NOT_SET'
						});
						console.log(`[MANUAL-ENTRY] Contact created via appendOrCreateContact`);
					}
				}
			} catch (contactError) {
				// Don't fail manual entry if contact creation fails
				console.warn(`[MANUAL-ENTRY] Warning: Failed to create contact:`, contactError.message);
			}
		}
		
		// Save the profile
		const profileResult = await wixData.save('SpecialtyProfiles', profileData);
		const profileId = profileResult._id;
		
		// Create weekly assignment records for each selected date
		const assignmentPromises = dateIds.map(async (dateId) => {
			return await wixData.save('WeeklyAssignments', {
				profileRef: profileId,
				dateRef: dateId,
				applicationStatus: 'Pending'
			});
		});
		
		await Promise.all(assignmentPromises);
		
		return {
			success: true,
			profileId: profileId,
			assignmentsCreated: dateIds.length
		};
	} catch (error) {
		console.error('Error in manualEntrySpecialtyProfile:', error);
		throw error;
	}
}
