import wixData from 'wix-data';

/**
 * DIAGNOSTIC FUNCTION - Check WeeklyAssignments data integrity
 * This will help us verify if approved assignments are actually in the database
 * and identify any data issues
 */
export async function checkAssignmentsStatus() {
	try {
		console.log('ðŸ” DIAGNOSTIC CHECK - Starting WeeklyAssignments analysis...');
		
		// Get ALL assignments WITHOUT include() first to see raw data
		const allAssignmentsRaw = await wixData.query('WeeklyAssignments')
			.find();
		
		console.log(`ðŸ“Š Total assignments in database (raw query): ${allAssignmentsRaw.items.length}`);
		
		// Now get with includes
		const allAssignments = await wixData.query('WeeklyAssignments')
			.include('profileRef')
			.include('dateRef')
			.find();
		
		console.log(`ðŸ“Š Total assignments with includes: ${allAssignments.items.length}`);
		
		// Analyze by status
		const statusBreakdown = {};
		const statusVariations = {}; // Track exact status strings (with whitespace, etc.)
		const approvedAssignments = [];
		const dataIssues = [];
		const missingNames = [];
		
		// Look specifically for "She Unites" and "Natalie Finley"
		let sheUnitesFound = false;
		let natalieFinleyFound = false;
		
		allAssignmentsRaw.items.forEach(assignment => {
			// Get status (handle various formats)
			const rawStatus = assignment.applicationStatus;
			const normalizedStatus = (rawStatus || 'null').toString().trim();
			const exactStatus = rawStatus ? JSON.stringify(rawStatus) : 'null';
			
			// Count by normalized status
			statusBreakdown[normalizedStatus] = (statusBreakdown[normalizedStatus] || 0) + 1;
			
			// Track exact status strings to catch whitespace/casing issues
			if (!statusVariations[normalizedStatus]) {
				statusVariations[normalizedStatus] = new Set();
			}
			statusVariations[normalizedStatus].add(exactStatus);
			
			// Check for broken references in raw data
			const hasProfileRef = !!assignment.profileRef;
			const hasDateRef = !!assignment.dateRef;
			
			if (!hasProfileRef) {
				dataIssues.push({
					id: assignment._id,
					issue: 'Missing profileRef',
					status: normalizedStatus,
					rawProfileRef: assignment.profileRef
				});
			}
			if (!hasDateRef) {
				dataIssues.push({
					id: assignment._id,
					issue: 'Missing dateRef', 
					status: normalizedStatus,
					rawDateRef: assignment.dateRef
				});
			}
			
			// Try to find She Unites and Natalie Finley by checking raw profileRef ID
			// We'll need to query SpecialtyProfiles separately to match names
		});
		
		// Direct search for "She Unites" and "Natalie Finley" in SpecialtyProfiles
		console.log('\nðŸ” SEARCHING FOR SPECIFIC PROFILES:');
		const missingAssignments = [];
		try {
			const sheUnitesProfiles = await wixData.query('SpecialtyProfiles')
				.contains('organizationName', 'She Unites')
				.find();
			console.log(`  Found ${sheUnitesProfiles.items.length} profile(s) matching "She Unites"`);
			sheUnitesProfiles.items.forEach(p => {
				console.log(`    - Profile ID: ${p._id}, Name: "${p.organizationName}", Type: ${p.type}`);
			});
			
			const finleyProfiles = await wixData.query('SpecialtyProfiles')
				.contains('organizationName', 'Finley')
				.or(wixData.query('SpecialtyProfiles').contains('firstName', 'Natalie'))
				.find();
			console.log(`  Found ${finleyProfiles.items.length} profile(s) matching "Natalie Finley"`);
			finleyProfiles.items.forEach(p => {
				const name = p.organizationName || `${p.firstName} ${p.lastName}`;
				console.log(`    - Profile ID: ${p._id}, Name: "${name}", Type: ${p.type}`);
			});
			
			// Now check if assignments exist for these profiles
			if (sheUnitesProfiles.items.length > 0) {
				const sheUnitesProfileId = sheUnitesProfiles.items[0]._id;
				const sheUnitesAssignments = await wixData.query('WeeklyAssignments')
					.eq('profileRef', sheUnitesProfileId)
					.find();
				console.log(`  Found ${sheUnitesAssignments.items.length} assignment(s) for She Unites profile`);
				for (const a of sheUnitesAssignments.items) {
					console.log(`    - Assignment ID: ${a._id}, Status: "${a.applicationStatus}"`);
					
					// Check if this assignment is in the raw query results
					const inRawQuery = allAssignmentsRaw.items.find(raw => raw._id === a._id);
					const inIncludeQuery = allAssignments.items.find(inc => inc._id === a._id);
					
					console.log(`      In raw query: ${!!inRawQuery}`);
					console.log(`      In include query: ${!!inIncludeQuery}`);
					
					if (inRawQuery && !inIncludeQuery) {
						console.error(`      âš ï¸ PROBLEM: Assignment exists in raw query but MISSING from include query!`);
						console.error(`      Raw profileRef: ${inRawQuery.profileRef}`);
						console.error(`      Raw dateRef: ${inRawQuery.dateRef}`);
						
						// Try to verify if the references are valid
						try {
							if (inRawQuery.profileRef) {
								const profileCheck = await wixData.get('SpecialtyProfiles', inRawQuery.profileRef);
								console.log(`      Profile exists: ${!!profileCheck}`);
							}
							if (inRawQuery.dateRef) {
								const dateCheck = await wixData.get('MarketDates2026', inRawQuery.dateRef);
								console.log(`      Date exists: ${!!dateCheck}`);
							}
						} catch (refError) {
							console.error(`      Error checking references: ${refError.message}`);
						}
						
						missingAssignments.push({
							name: 'She Unites',
							assignmentId: a._id,
							profileRef: inRawQuery.profileRef,
							dateRef: inRawQuery.dateRef,
							status: a.applicationStatus
						});
					}
				}
			}
			
			if (finleyProfiles.items.length > 0) {
				const finleyProfileId = finleyProfiles.items[0]._id;
				const finleyAssignments = await wixData.query('WeeklyAssignments')
					.eq('profileRef', finleyProfileId)
					.find();
				console.log(`  Found ${finleyAssignments.items.length} assignment(s) for Natalie Finley profile`);
				for (const a of finleyAssignments.items) {
					console.log(`    - Assignment ID: ${a._id}, Status: "${a.applicationStatus}"`);
					
					// Check if this assignment is in the raw query results
					const inRawQuery = allAssignmentsRaw.items.find(raw => raw._id === a._id);
					const inIncludeQuery = allAssignments.items.find(inc => inc._id === a._id);
					
					console.log(`      In raw query: ${!!inRawQuery}`);
					console.log(`      In include query: ${!!inIncludeQuery}`);
					
					if (inRawQuery && !inIncludeQuery) {
						console.error(`      âš ï¸ PROBLEM: Assignment exists in raw query but MISSING from include query!`);
						console.error(`      Raw profileRef: ${inRawQuery.profileRef}`);
						console.error(`      Raw dateRef: ${inRawQuery.dateRef}`);
						
						// Try to verify if the references are valid
						try {
							if (inRawQuery.profileRef) {
								const profileCheck = await wixData.get('SpecialtyProfiles', inRawQuery.profileRef);
								console.log(`      Profile exists: ${!!profileCheck}`);
							}
							if (inRawQuery.dateRef) {
								const dateCheck = await wixData.get('MarketDates2026', inRawQuery.dateRef);
								console.log(`      Date exists: ${!!dateCheck}`);
							}
						} catch (refError) {
							console.error(`      Error checking references: ${refError.message}`);
						}
						
						missingAssignments.push({
							name: 'Natalie Finley',
							assignmentId: a._id,
							profileRef: inRawQuery.profileRef,
							dateRef: inRawQuery.dateRef,
							status: a.applicationStatus
						});
					}
				}
			}
			
			if (missingAssignments.length > 0) {
				console.error(`\nâŒ CRITICAL ISSUE: ${missingAssignments.length} approved assignment(s) are MISSING from include query results:`);
				missingAssignments.forEach(m => {
					console.error(`  - ${m.name} (Assignment ID: ${m.assignmentId})`);
					console.error(`    ProfileRef: ${m.profileRef}`);
					console.error(`    DateRef: ${m.dateRef}`);
				});
			}
		} catch (searchError) {
			console.error('  Error searching for specific profiles:', searchError);
		}
		
		// Now analyze the included data
		allAssignments.items.forEach(assignment => {
			const rawStatus = assignment.applicationStatus;
			const normalizedStatus = (rawStatus || 'null').toString().trim();
			
			// Get organization name from profile
			const orgName = assignment.profileRef?.organizationName || 
			                assignment.profileRef?.firstName + ' ' + assignment.profileRef?.lastName || 
			                'Unknown';
			
			// Check for specific names
			if (orgName.toLowerCase().includes('she unites')) {
				sheUnitesFound = true;
				console.log(`ðŸ” FOUND "She Unites": Status="${normalizedStatus}", ID=${assignment._id}`);
				console.log(`   Profile:`, assignment.profileRef);
				console.log(`   Date:`, assignment.dateRef);
			}
			if (orgName.toLowerCase().includes('natalie finley') || orgName.toLowerCase().includes('finley')) {
				natalieFinleyFound = true;
				console.log(`ðŸ” FOUND "Natalie Finley": Status="${normalizedStatus}", ID=${assignment._id}`);
				console.log(`   Profile:`, assignment.profileRef);
				console.log(`   Date:`, assignment.dateRef);
			}
			
			// Track approved assignments
			if (normalizedStatus.toLowerCase() === 'approved') {
				approvedAssignments.push({
					id: assignment._id,
					status: normalizedStatus,
					profileType: assignment.profileRef?.type || 'Unknown',
					organizationName: orgName,
					profileId: assignment.profileRef?._id || 'No profile ID',
					dateId: assignment.dateRef?._id || assignment.dateRef || 'Unknown',
					dateTitle: assignment.dateRef?.title || 'Unknown',
					createdDate: assignment._createdDate,
					updatedDate: assignment._updatedDate,
					hasProfileRef: !!assignment.profileRef,
					hasDateRef: !!assignment.dateRef
				});
			}
			
			// Check if profileRef resolved properly
			if (assignment.profileRef === null || assignment.profileRef === undefined) {
				missingNames.push({
					id: assignment._id,
					status: normalizedStatus,
					issue: 'profileRef is null after include()',
					rawProfileRef: allAssignmentsRaw.items.find(a => a._id === assignment._id)?.profileRef
				});
			}
		});
		
		console.log('\nðŸ“‹ STATUS BREAKDOWN:');
		console.log(JSON.stringify(statusBreakdown, null, 2));
		
		console.log('\nðŸ” STATUS VARIATIONS (checking for whitespace/casing issues):');
		for (const [normalized, variations] of Object.entries(statusVariations)) {
			if (variations.size > 1) {
				console.warn(`  âš ï¸ "${normalized}" has ${variations.size} variations:`, Array.from(variations));
			}
		}
		
		console.log(`\nðŸ” SPECIFIC SEARCH RESULTS:`);
		console.log(`  She Unites found: ${sheUnitesFound ? 'YES âœ…' : 'NO âŒ'}`);
		console.log(`  Natalie Finley found: ${natalieFinleyFound ? 'YES âœ…' : 'NO âŒ'}`);
		
		console.log(`\nâœ… APPROVED ASSIGNMENTS: ${approvedAssignments.length}`);
		if (approvedAssignments.length > 0) {
			console.log('\nðŸ“‹ FULL LIST OF APPROVED ASSIGNMENTS:');
			console.log('='.repeat(80));
			approvedAssignments.forEach((a, index) => {
				console.log(`\n${index + 1}. ${a.profileType}: "${a.organizationName}"`);
				console.log(`   Date: ${a.dateTitle}`);
				console.log(`   Assignment ID: ${a.id}`);
				console.log(`   Profile ID: ${a.profileId}`);
				console.log(`   Date ID: ${a.dateId}`);
				console.log(`   Status: "${a.status}"`);
				console.log(`   Has Profile: ${a.hasProfileRef}, Has Date: ${a.hasDateRef}`);
			});
			console.log('='.repeat(80));
			
			// Also output as a simple list for easy scanning
			console.log('\nðŸ“ QUICK REFERENCE - Approved Assignment Names:');
			approvedAssignments.forEach((a, index) => {
				console.log(`   ${index + 1}. ${a.organizationName} (${a.profileType})`);
			});
		} else {
			console.warn('âš ï¸ WARNING: NO APPROVED ASSIGNMENTS FOUND IN DATABASE');
		}
		
		if (dataIssues.length > 0) {
			console.log(`\nâš ï¸ DATA INTEGRITY ISSUES (broken references): ${dataIssues.length}`);
			dataIssues.forEach(issue => {
				console.log(`  - ${issue.issue} (Assignment ID: ${issue.id}, Status: ${issue.status})`);
				console.log(`    Raw value:`, issue.rawProfileRef || issue.rawDateRef);
			});
		}
		
		if (missingNames.length > 0) {
			console.log(`\nâš ï¸ UNRESOLVED REFERENCES (include() failed): ${missingNames.length}`);
			missingNames.forEach(issue => {
				console.log(`  - ${issue.issue} (Assignment ID: ${issue.id}, Status: ${issue.status})`);
				console.log(`    Raw profileRef from DB:`, issue.rawProfileRef);
			});
		}
		
		// Return summary
		const summaryMessage = missingAssignments.length > 0
			? `âš ï¸ CRITICAL: Found ${approvedAssignments.length} approved assignments, but ${missingAssignments.length} are MISSING from query results due to broken references. Check console for details.`
			: approvedAssignments.length > 0 
				? `Found ${approvedAssignments.length} approved assignments in database. They should be visible when Status filter is set to "Approved" or "All Statuses".`
				: 'WARNING: No approved assignments found. This indicates potential data loss or status field corruption.';
		
		return {
			success: true,
			totalAssignments: allAssignments.items.length,
			statusBreakdown,
			approvedCount: approvedAssignments.length,
			approvedAssignments,
			dataIssues,
			missingNames,
			missingAssignments,
			sheUnitesFound,
			natalieFinleyFound,
			message: summaryMessage
		};
		
	} catch (error) {
		console.error('âŒ ERROR in diagnostic check:', error);
		console.error('Error details:', error.message, error.stack);
		return {
			success: false,
			error: error.message,
			stack: error.stack
		};
	}
}

/**
 * Check specific date availability status
 * Useful for debugging why dates show as "available" when they should be reserved
 */
export async function checkDateAvailability(dateId) {
	try {
		console.log(`ðŸ” Checking availability for date ID: ${dateId}`);
		
		// Get all assignments for this date
		const assignments = await wixData.query('WeeklyAssignments')
			.eq('dateRef', dateId)
			.include('profileRef')
			.include('dateRef')
			.find();
		
		console.log(`Found ${assignments.items.length} total assignments for this date`);
		
		// Filter for approved only
		const approved = assignments.items.filter(a => {
			const status = (a.applicationStatus || '').toString().trim().toLowerCase();
			return status === 'approved';
		});
		
		console.log(`Found ${approved.items.length} APPROVED assignments for this date`);
		
		// Breakdown by type
		const breakdown = {
			Musician: 0,
			NonProfit: 0,
			Volunteer: 0
		};
		
		approved.forEach(a => {
			const type = a.profileRef?.type;
			if (breakdown[type] !== undefined) {
				breakdown[type]++;
			}
		});
		
		console.log('Approved assignments by type:', breakdown);
		
		return {
			dateId,
			totalAssignments: assignments.items.length,
			approvedAssignments: approved.length,
			breakdown,
			details: approved.map(a => ({
				id: a._id,
				type: a.profileRef?.type,
				name: a.profileRef?.organizationName,
				status: a.applicationStatus
			}))
		};
		
	} catch (error) {
		console.error('Error checking date availability:', error);
		return { error: error.message };
	}
}
